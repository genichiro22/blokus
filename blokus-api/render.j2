<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            var a_canvas = $("#a_canvas")[0],
            ctx = a_canvas.getContext("2d");
{% for c in field %}
{% if c.value == 0 %}
            ctx.fillStyle = "white";
{% elif c.value == 1 %}
            ctx.fillStyle = "red"
{% elif c.value == 2 %}
            ctx.fillStyle = "green"
{% elif c.value == 3 %}
            ctx.fillStyle = "blue"
{% elif c.value == 4 %}
            ctx.fillStyle = "yellow"
{% endif %}
            ctx.fillRect({{ 20*(1+c.x) }}, {{ 20*(1+c.y) }}, 20, 20);
            ctx.strokeStyle = "#DDD";
            ctx.lineWidth = 1;
            ctx.strokeRect({{ 20*(c.x + 1) }}, {{ 20*(c.y + 1) }}, 20, 20);
{% endfor %}
            ctx.fillStyle = "black";
{% for i in range(20) %}
            ctx.fillText({{ i }}, 1,{{ 34+20*i }});
            ctx.fillText({{ i }}, {{ 24 + 20*i }}, 16);
{% endfor %}
{% for i in range(4) %}
{% for j in range(4) %}
            ctx.strokeStyle = "#AAA";
            ctx.strokeRect({{ 20+100*i }}, {{ 20+100*j }},100,100);
{% endfor %}
{% endfor %}
        });
    </script>
</head>
<body>
    <div class="container">
    <div class="field">
    <canvas width="450" height="430" id="a_canvas">
    </canvas>
    </div>
    <div class="commit">
        <form class="commit-form" method="" action="" onsubmit="return false">
            <div class="commit-form">
                <label for="player">player:</label>
                <input type="number" name="player" id="player" required>
            </div>
            <div class="commit-form">
                <label for="piece-id">piece-id:</label>
                <input type="number" name="piece-id" id="piece-id" required>
            </div>
            <div class="commit-form">
                <label for="fliprot-id">fliprot-id:</label>
                <input type="number" name="fliprot-id" id="fliprot-id" required>
            </div>
            <div class="x">
                <label for="x">x:</label>
                <input type="number" name="x" id="x" required>
            </div>
            <div class="y">
                <label for="y">y:</label>
                <input type="number" name="y" id="y" required>
            </div>
            <input type="submit" value="送信">
        </form>
    </div>
    <div class="fliprot">
{% for i in range(8) %}
    <div class="f{{ i }}">
    <canvas width="100" height="100" style="background-color:#ccc;" id="{{ i }}_fliprot">
    </canvas>
    </div>
{% endfor %}
    </div>
    <div class="pieces">
{% for i in range(21) %}
    <div class="p{{ i }}">
    <canvas width="100" height="100" style="background-color:#ccc;" id="{{ i }}_base">
    </canvas>
    </div>
{% endfor %}
    </div>
    </div>
    <script>
    function b_func() {
        function onClick(e) {
            let button = e.target.getBoundingClientRect();
	        let mouseX = e.clientX - button.left;
    		let mouseY = e.clientY - button.top;
            let x = Math.floor(mouseX/20) - 1
            let y = Math.floor(mouseY/20) - 1
            inputXy(x, y);
        }
        function inputXy(s1, s2) {
            document.querySelector("#x").value = s1;
            document.querySelector("#y").value = s2;
        }
        a_canvas.addEventListener('click', onClick);
    }
    b_func();
    </script>
    <script>
        const btn = document.querySelector("body > div > div.commit > form > input[type=submit]");
        const player = document.querySelector("#player");
        const pieceId = document.querySelector("#piece-id");
        const flipRotId = document.querySelector("#fliprot-id");
        let x = document.querySelector("#x");
        let y = document.querySelector("#y");
        function sendData( data ) {
            const body = {
                "player": Number(player.value),
                "piece_id": Number(pieceId.value),
                "fr_id": Number(flipRotId.value),
                "coordinate": {
                    "x": Number(x.value),
                    "y": Number(y.value)
                }
            }
            body_s = JSON.stringify(body)
            const XHR = new XMLHttpRequest();
            XHR.open("PUT", "/field/piece");
            XHR.setRequestHeader("Content-Type", "application/json");
            XHR.onload = function () {
                console.log('DONE: ', XHR.status);
                if (XHR.status===200) {
                    window.location.reload();
                } else if (XHR.status===422) {
                    window.alert(XHR.response);
                }
            };
            XHR.send(body_s);
        }
        btn.addEventListener('click', sendData);
    </script>
</body>
</html>